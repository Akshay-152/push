<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Enable Notifications</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;background:#071428;color:#e6eef6;padding:40px;text-align:center}
    button{background:#2dd4bf;border:0;padding:12px 18px;border-radius:10px;color:#042027;font-weight:700;cursor:pointer}
    pre{background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;max-width:760px;margin:18px auto;text-align:left}
    code{color:#94a3b8}
  </style>
</head>
<body>
  <h1>ðŸ”” Enable Notifications</h1>
  <p>Click to allow notifications â€” your subscription will be saved in Firestore collection <code>tocken</code>.</p>
  <button id="btn-subscribe">Enable Notifications</button>
  <p>Your device UID: <code id="uidEl">â€”</code></p>
  <pre id="log">Ready</pre>

  <script type="module">
    // ---------- CLIENT CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyC-ft54KwehdTIsV93xBjLbd0nMeZ4ibDw",
      authDomain: "akshay-b744a.firebaseapp.com",
      projectId: "akshay-b744a",
      storageBucket: "akshay-b744a.firebasestorage.app",
      messagingSenderId: "752091661451",
      appId: "1:752091651451:web:7ccfa46feff8ce87c6808e",
      measurementId: "G-GKLRSSBRXR"
    };

    // Your VAPID public key (client-side only)
    const VAPID_PUBLIC_KEY = 'BDUtG4Fe5BEdidnYGx4laC8xyaGwKmVUwWf_rfRfIPERSnIY_wUQcPc-MXzuMIEQ7Y1Lz5EEpGVQEMueGPw5_yU';

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const logEl = document.getElementById('log');
    const uidEl = document.getElementById('uidEl');
    const BTN = document.getElementById('btn-subscribe');
    const UID_KEY = 'device_uid_v1';

    function log(v){ console.log(v); logEl.textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2); }
    function genUID(){ return Math.floor(10000000 + Math.random()*90000000).toString(); }
    function getUID(){ let id = localStorage.getItem(UID_KEY); if(!id){ id = genUID(); localStorage.setItem(UID_KEY, id); } return id; }

    function urlBase64ToUint8Array(base64String){
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g,'+').replace(/_/g,'/');
      const rawData = atob(base64);
      const out = new Uint8Array(rawData.length);
      for (let i=0;i<rawData.length;++i) out[i]=rawData.charCodeAt(i);
      return out;
    }

    async function registerSW(){
      if(!('serviceWorker' in navigator)) throw new Error('No service worker support');
      const reg = await navigator.serviceWorker.register('/push/sw.js');
      return reg;
    }

    async function saveToFirestore(uid, subscription){
      const subJson = subscription && subscription.toJSON ? subscription.toJSON() : subscription;
      await setDoc(doc(db, 'tocken', uid), { uid, subscription: subJson, savedAt: serverTimestamp() });
    }

    async function subscribeFlow(){
      try{
        log('Registering service worker...');
        const reg = await registerSW();

        if(!confirm('Tap OK to allow notifications (browser permission will appear).')) { log('Cancelled'); return; }

        const perm = await Notification.requestPermission();
        if(perm !== 'granted'){ log('Permission not granted'); return; }

        log('Subscribing to push...');
        const sub = await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) });

        const uid = getUID();
        await saveToFirestore(uid, sub);
        uidEl.textContent = uid;
        log({ msg: 'Subscribed and saved', uid, endpoint: sub.endpoint });
      }catch(err){
        console.error(err);
        log('Error: ' + (err.message || err));
      }
    }

    BTN.addEventListener('click', subscribeFlow);
    // init
    uidEl.textContent = getUID();
    log('Ready');
  </script>
</body>
</html>
