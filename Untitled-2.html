<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FCM — Minimal Popup</title>
  <style>
    :root{--bg:#071028;--accent1:#06b6d4;--accent2:#2563eb;--glass:rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{background:linear-gradient(180deg,var(--bg),#051226);display:flex;align-items:center;justify-content:center;color:#eaf4ff}
    .card{width:94%;max-width:920px;padding:22px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid var(--glass)}
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.75));display:grid;place-items:center;z-index:60}
    .modal{width:360px;max-width:calc(100% - 32px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.8);border:1px solid rgba(255,255,255,0.03);text-align:center}
    .btns{display:flex;gap:8px;justify-content:center}
    .btn{padding:10px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#022}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
    .tokenBox{margin-top:12px;padding:10px;border-radius:8px;background:transparent;border:1px dashed rgba(255,255,255,0.04);min-height:64px;word-break:break-all}
    .small{font-size:13px;color:rgba(230,238,248,0.7)}
    .floating{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 12px;border-radius:999px;color:#022;font-weight:700;cursor:pointer;border:0}
    .modal{transform:translateY(12px);opacity:0;transition:transform .28s cubic-bezier(.2,.9,.3,1),opacity .28s}
    .overlay.show .modal{transform:none;opacity:1}
    @media (max-width:420px){.modal{width:92%}}
  </style>
</head>
<body>
  <div class="card">
    <h1 style="margin:0 0 8px 0;font-size:18px">FCM — Minimal Popup Mode</h1>
    <div class="small">This page requests notification permission and displays the generated FCM token. (HTTPS required.)</div>
  </div>

  <button id="openModal" class="floating" title="Open token popup">Get Token</button>

  <div id="overlay" class="overlay" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>Allow notifications?</h2>
      <p>We need permission to create a push token for this browser. The token will show here only.</p>

      <div class="btns">
        <button id="allowBtn" class="btn primary">Allow</button>
        <button id="denyBtn" class="btn ghost">Deny</button>
      </div>

      <div id="tokenArea" style="display:none" aria-live="polite">
        <div class="tokenBox" id="tokenBox">—</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
          <button id="copyToken" class="btn ghost">Copy</button>
          <button id="closeBtn" class="btn ghost">Close</button>
        </div>
      </div>

      <div id="status" class="small" style="margin-top:10px">Status: <span id="statusText">idle</span></div>
    </div>
  </div>

  <!-- Firebase (modular) ES module CDN -->
  <script type="module">
   // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAd-SQmyTES3_C_WIjpN557aNvI_vwDmWM",
  authDomain: "push-1c3e6.firebaseapp.com",
  projectId: "push-1c3e6",
  storageBucket: "push-1c3e6.firebasestorage.app",
  messagingSenderId: "332269974589",
  appId: "1:332269974589:web:413a4eaa0f0cda2e666654",
  measurementId: "G-XHE5WVZ8XV"
};
    const VAPID_KEY = 'BEvvtJOzrpNmR25o_7g6C7I1hPtd8XEamwEBJo0HWduhRi9kCqpzx5r-yEjTTQ5StFvL1pfE_J76wZc2sT9gxSE';
    
//========================================

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js';

    const app = initializeApp(FIREBASE_CONFIG);
    const messaging = getMessaging(app);

    // UI refs
    const overlay = document.getElementById('overlay');
    const openModal = document.getElementById('openModal');
    const allowBtn = document.getElementById('allowBtn');
    const denyBtn = document.getElementById('denyBtn');
    const closeBtn = document.getElementById('closeBtn');
    const tokenArea = document.getElementById('tokenArea');
    const tokenBox = document.getElementById('tokenBox');
    const statusText = document.getElementById('statusText');
    const copyBtn = document.getElementById('copyToken');

    function setStatus(s){ statusText.textContent = s; }
    function showOverlay(){ overlay.style.display = 'grid'; setTimeout(()=>overlay.classList.add('show'),20); }
    function hideOverlay(){ overlay.classList.remove('show'); setTimeout(()=>overlay.style.display='none',300); }
    function setToken(t){ tokenBox.textContent = t || '—'; }

    // REGISTER SERVICE WORKER PROPERLY (must be a separate file)
    async function registerSW(){
      if('serviceWorker' in navigator){
        try{
          // register the separate file at root: /firebase-messaging-sw.js
         await navigator.serviceWorker.register('/push/firebase-messaging-sw.js');

          console.log('SW registered', reg);
          return reg;
        }catch(e){
          console.warn('SW register failed', e);
          throw e;
        }
      }else{
        throw new Error('Service workers unsupported');
      }
    }

    async function requestPermissionAndGetToken(){
      try{
        setStatus('requesting permission');
        const permission = await Notification.requestPermission();
        setStatus(permission);
        if(permission !== 'granted'){ setStatus('permission denied'); return null; }

        setStatus('registering service worker');
        await registerSW();

        setStatus('retrieving token');
        const token = await getToken(messaging, { vapidKey: VAPID_KEY });
        if(token){ setToken(token); tokenArea.style.display = 'block'; setStatus('token received'); return token; }
        else{ setStatus('no token — check config'); return null; }
      }catch(err){ console.error(err); setStatus('error'); return null; }
    }

    // Button bindings
    openModal.addEventListener('click', ()=>{ showOverlay(); });
    allowBtn.addEventListener('click', async ()=>{
      allowBtn.disabled = true;
      setStatus('processing...');
      await requestPermissionAndGetToken();
      allowBtn.disabled = false;
    });
    denyBtn.addEventListener('click', ()=>{ setStatus('denied'); hideOverlay(); });
    closeBtn.addEventListener('click', ()=>{ hideOverlay(); });

    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(tokenBox.textContent); setStatus('copied'); }
      catch(e){ setStatus('copy failed'); }
    });

    // On load: show minimal popup if permission is default; if already granted, try silent token fetch
    window.addEventListener('load', async ()=>{
      try{
        const p = Notification.permission;
        if(p === 'default'){ showOverlay(); }
        else if(p === 'granted'){
          setStatus('getting token silently');
          try{ await registerSW(); const t = await getToken(messaging, { vapidKey: VAPID_KEY }); if(t){ setToken(t); tokenArea.style.display='block'; setStatus('token ready'); } }
          catch(e){ console.warn(e); setStatus('silent failed'); }
        } else { setStatus('permission denied'); }

        // foreground messages
        onMessage(messaging, (payload)=>{ console.log('Foreground message:', payload); alert('Message while page focused:\\n' + (payload?.notification?.title || JSON.stringify(payload))); });
      }catch(e){ console.error(e); }
    });
  </script>
</body>
</html>

